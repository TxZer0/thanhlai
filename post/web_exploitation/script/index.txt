<?php
if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['file'], $_GET['action'])) {
    $action = $_GET['action'];
    $filePath = $_GET['file'];

    $realPath = realpath(__DIR__ . '/' . $filePath);
    $uploadDir = realpath(__DIR__ . '/uploads');

    if (strpos($realPath, $uploadDir) === 0 && file_exists($realPath)) {
        if ($action === 'preview') {      
            header('Content-Disposition: inline; filename="' . basename($realPath) . '"');        
        } elseif ($action === 'download') {
            header('Content-Disposition: attachment; filename="' . basename($realPath) . '"');
        }
        header('Content-Type: application/xml');
        readfile($realPath);
        exit;
    } else {
        
        header('Content-Type: text/plain');
        echo "File không tồn tại hoặc không hợp lệ!";
        exit;
    }
}

$uploadedFile = null;
$showActions = false;

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['xml_file'])) {
    $file = $_FILES['xml_file'];
    if ($file['error'] === UPLOAD_ERR_OK && pathinfo($file['name'], PATHINFO_EXTENSION) === 'xml') {
        $uploadDir = __DIR__ . '/uploads/';
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0777, true);
        }

        $filename = uniqid() . '.xml';
        $filePath = $uploadDir . $filename;
        move_uploaded_file($file['tmp_name'], $filePath);
        $uploadedFile = 'uploads/' . $filename;
        $showActions = true;
    } else {
        echo "<p style='color:red;'>Chỉ được upload file XML hợp lệ!</p>";
    }
}
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Upload XML File</title>
</head>
<body>
    <h1>Upload XML File</h1>

    <form method="POST" enctype="multipart/form-data">
        <input type="file" name="xml_file" accept=".xml" required>
        <button type="submit">Upload</button>
    </form>

    <?php if ($showActions): ?>
        <form method="GET">
            <input type="hidden" name="file" value="<?php echo htmlspecialchars($uploadedFile); ?>">
            <button type="submit" name="action" value="preview">Preview</button>
            <button type="submit" name="action" value="download">Download</button>
        </form>
    <?php endif; ?>
</body>
</html>
