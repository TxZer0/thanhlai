# Charlies_Angels
<p>Trong file app.py cá»§a thÆ° má»¥c py,  endpoint /backup dÃ¹ng Ä‘á»ƒ sao lÆ°u dá»¯ liá»‡u theo hai cÃ¡ch: nháº­n file Ä‘Æ°á»£c táº£i lÃªn hoáº·c nháº­n dá»¯ liá»‡u dÆ°á»›i dáº¡ng JSON. DÃ²ng 15, dÃ¹ng danh sÃ¡ch BANNED Ä‘á»ƒ cháº·n táº£i lÃªn cÃ¡c file nhÆ° app.py, flag vÃ  requirements.txt. Chuá»—i <code>..</code> bá»‹ cáº¥m trong filename. Sau Ä‘Ã³, file Ä‘Æ°á»£c ghi vÃ o thÆ° má»¥c backups. Náº¿u sá»­ dá»¥ng JSON thÃ¬ láº¥y id Ä‘á»ƒ táº¡o tÃªn file vÃ  ghi ná»™i dung tá»« angel vÃ o.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-5.png)

<p>Endpoint /restore thá»±c hiá»‡n cháº¡y script náº¿u Ä‘Æ°á»ng dáº«n há»£p lá»‡ -> CÃ³ thá»ƒ RCE náº¿u upload Ä‘Æ°á»£c file python. MÃ  á»Ÿ endpoint /backup cho phÃ©p táº£i lÃªn file Ä‘á»ƒ sao lÆ°u. Káº¿t há»£p láº¡i thÃ¬ cÃ³ thá»ƒ upload file lÃªn /backup vÃ  truy cáº­p vÃ o /restore vá»›i id lÃ  filename Ä‘á»ƒ thá»±c thi script.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-6.png)

<p>Tuy nhiÃªn, services py khÃ´ng thá»ƒ truy cáº­p tá»« bÃªn ngoÃ i vÃ  chá»‰ cÃ³ thá»ƒ cáº­p thÃ´ng qua services node.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-7.png)

<p>Trong file index.js cá»§a thÆ° má»¥c node, dÃ²ng 59 thá»±c hiá»‡n POST ná»™i dung lÃªn http://localhost:1338/backup -> Dá»±a vÃ o Ä‘iá»u nÃ y Ä‘á»ƒ gá»­i file qua /backup. DÃ²ng 55, giÃ¡ trá»‹ cá»§a angel trong data Ä‘Æ°á»£c láº¥y tá»« req.session.angel. MÃ  req.session.angel Ä‘Æ°á»£c láº¥y tá»« req.body.angel nÃªn cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c pháº§n tá»­ angel trong data khi POST lÃªn http://localhost:1338/backup.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-3.png)

<p>Endpoint /restore, truy cáº­p tá»›i http://localhost:1338/restore vá»›i id lÃ  sessionID -> Chá»‰ cÃ³ thá»ƒ truy cáº­p báº±ng sessionID -> TÃªn file upload tá»›i /backup pháº£i cÃ³ filename trÃ¹ng vá»›i sessionID.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-4.png)

<p>Thá»­ POST lÃªn /angel má»™t object cÃ³ sáºµn chá»©a pháº§n tá»­ angel vÃ  Ä‘á»•i giÃ¡ trá»‹ cá»§a Content-Type sang application/json. Káº¿t quáº£ tráº£ vá» lÃ  sessionID.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image.png)

<p>Kiá»ƒm tra thÆ° má»¥c backups thÃ¬ tháº¥y chÆ°a cÃ³ file nÃ o Ä‘Æ°á»£c táº¡o ra -> CÃ³ váº» lÃ  do HTTP request cá»§a node gá»­i qua py khÃ´ng chÃ­nh xÃ¡c hoáº·c do nguyÃªn nhÃ¢n nÃ o Ä‘Ã³.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-10.png)

<p>Thá»­ báº¯t láº¡i HTTP request báº±ng cÃ¡ch gá»­i qua burp suite trÆ°á»›c khi Ä‘áº¿n /backup báº±ng Ä‘oáº¡n code sau:</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-11.png)

<p>CÃ³ váº» nhÆ° do thiáº¿u <code>filename="abc"</code> nÃªn khÃ´ng thá»ƒ truy cáº­p vÃ o filename vÃ  dáº«n Ä‘áº¿n viá»‡c ghi dá»¯ liá»‡u khÃ´ng thÃ nh cÃ´ng. CÃ¡c giÃ¡ trá»‹ cá»§a name trong header Content-Disposition Ä‘á»u sá»­ dá»¥ng [key] Ä‘á»ƒ thá»ƒ hiá»‡n tá»«ng key cá»§a angel khi gá»­i dá»¯ liá»‡u Ä‘i. CÃ²n pháº§n body lÃ  giÃ¡ trá»‹ cá»§a tá»«ng key cá»¥ thá»ƒ.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-9.png)

<p>Thá»­ thÃªm <code>"</code> vÃ o sau name Ä‘á»ƒ kiá»ƒm tra xem cÃ³ thá»ƒ inject vÃ o giÃ¡ trá»‹ cá»§a name trong header Content-Disposition khÃ´ng.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-16.png)

<p>Káº¿t quáº£ lÃ  <code>"</code> Ä‘Ã£ Ä‘Ã³ng láº¡i chuá»—i giÃ¡ trá»‹ -> CÃ³ thá»ƒ inject Ä‘Æ°á»£c.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-15.png)

<p>Thá»­ <code>"; filename="abc.py"</code> -> ChÃ¨n Ä‘Æ°á»£c filename thÃ nh cÃ´ng. ChÆ°a rÃµ hai kÃ­ tá»± thá»«a sau filename cÃ³ gÃ¢y lá»—i khÃ´ng -> Táº¡m thá»i Ä‘á»ƒ Ä‘Ã³.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-17.png)

<p>BÃ¢y giá», cáº§n láº¥y ra sessionID Ä‘á»ƒ Ä‘áº·t tÃªn file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-18.png)

<p>DÃ¹ng sessionID lÃ m filename Ä‘á»ƒ inject vÃ o name -> Káº¿t quáº£ lÃ  khÃ´ng cÃ³ file nÃ o Ä‘Æ°á»£c ghi (chÆ°a rÃµ nguyÃªn nhÃ¢n).</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-19.png)

<p>Thá»­ cÃ¡ch trÃªn vá»›i cÃ¡c key cÃ²n láº¡i -> Vá»›i cÃ¡c key trong angel.talents thÃ¬ táº¡o file thÃ nh cÃ´ng. </p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-20.png)

<p>Truy cáº­p /restore -> Script Ä‘Æ°á»£c thá»±c thi vÃ  tráº£ vá» ná»™i dung flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-1.png)

# Log_Me_In
<p>Trong routes.py, endpoint /login thá»±c hiá»‡n kiá»ƒm tra username/password vÃ  set cookie Ä‘á»ƒ Ä‘Äƒng nháº­p. Password Ä‘Ã£ Ä‘Æ°á»£c hash báº±ng hÃ m sha265 nÃªn khÃ´ng inject vÃ o trÆ°á»ng nÃ y Ä‘Æ°á»£c. Username thÃ¬ Ä‘Æ°á»£c kiá»ƒm tra bá»Ÿi hÃ m is_alphanumeric. Cuá»‘i cÃ¹ng, tráº£ vá» cookie tá»« thÃ´ng tin user.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-21.png)

<p>Endpoint /register cÅ©ng kiá»ƒm tra username/password tÆ°Æ¡ng tá»± nhÆ° login.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-22.png)

<p>HÃ m is_alphanumeric sá»­ dá»¥ng biá»ƒu thá»©c chÃ­nh quy Ä‘á»ƒ giá»›i háº¡n kÃ­ tá»± -> KhÃ´ng cÃ³ SQL injection -> CÃ³ váº» nhÆ° sáº½ pháº£i exploit cookie.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-28.png)

<p>Táº¡i endpoind /user, dÃ²ng 87 tráº£ vá» ná»™i dung flag náº¿u uid cá»§a userinfo báº±ng 0. Biáº¿n userinfo lÃ  káº¿t quáº£ sau khi decode cookie.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-23.png)

<p>HÃ m decode giáº£i mÃ£ chuá»—i hex (giÃ¡ trá»‹ cookie) Ä‘Ã³ vá» láº¡i dictionary báº±ng cÃ¡ch thá»±c hiá»‡n XOR. CÃ³ thá»ƒ táº­n dá»¥ng hÃ m encode cÃ³ sáºµn Ä‘á»ƒ táº¡o nÃªn cookie cÃ³ uid báº±ng 0. Tuy nhiÃªn, váº«n chÆ°a cÃ³ ENCRYPT_KEY thá»±c sá»± nÃªn pháº£i tÃ¬m cÃ¡ch Ä‘á»ƒ leak ra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-24.png)

<p>Táº­n dá»¥ng hÃ m encode cÃ³ sáºµn, thay Ä‘á»•i cáº·p giÃ¡ trá»‹ dÃ¹ng Ä‘á»ƒ XOR thÃ nh dictionary ban Ä‘áº§u vÃ  giÃ¡ trá»‹ cookie info -> Láº¥y ra Ä‘Æ°á»£c giÃ¡ trá»‹ ENCRYPT_KEY.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-29.png)

<p>Tuy nhiÃªn, má»›i chá»‰ leak Ä‘Æ°á»£c 1 pháº§n giÃ¡ trá»‹ -> CÃ³ váº» cáº§n pháº£i lÃ m cho dictionary dÃ i ra thÃ¬ má»›i leak Ä‘Æ°á»£c toÃ n bá»™ key. TrÆ°á»ng username vÃ  displayname Ä‘á»u Ä‘Æ°á»£c phÃ©p tá»‘i Ä‘a lÃ  50 kÃ­ tá»±.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-210.png)

<p>Khi thá»­ tá»‘i Ä‘a 50 kÃ­ tá»± cho cáº£ 2 trÆ°á»ng vÃ  thay Ä‘á»•i cookie má»›i thÃ¬ khi so sÃ¡nh váº«n chÆ°a leak ra háº¿t Ä‘Æ°á»£c. Tuy nhiÃªn, vÃ¬ hÃ m encode vÃ  decode Ä‘á»u XOR theo tá»«ng byte nÃªn Ä‘á»™ dÃ i cá»§a khÃ³a chá»‰ cáº§n lá»›n hÆ¡n hoáº·c báº±ng Ä‘á»™ dÃ i cá»§a cookie lÃ  káº¿t quáº£ váº«n chÃ­nh xÃ¡c.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-2.png)

<p>Thá»­ decode cookie hiá»‡n táº¡i, uid hiá»‡n táº¡i Ä‘ang lÃ  1.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-26.png)

<p>Thay Ä‘á»•i uid thÃ nh 0 vÃ  encode láº¡i lÃ  xong.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-27.png)

<p>Cáº­p nháº­t giÃ¡ trá»‹ cookie vÃ  refresh Ä‘á»ƒ nháº­n flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-30.png)

# Lost_Pyramid
<p>Trong app.py, endpoint /entrance táº¡o ra má»™t token vá»›i khÃ³a lÃ  PRIVATE_KEY, thuáº­t toÃ¡n lÃ  EdDSA Ä‘á»ƒ lÃ m giÃ¡ trá»‹ cá»§a cookie pyramid.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-40.png)

<p>Endpoint /scarab_room nháº­n tham sá»‘ name. Sau Ä‘Ã³, duyá»‡t qua tá»«ng kÃ­ tá»± vÃ  chá»‰ giá»¯ láº¡i cÃ¡c kÃ­ tá»± há»£p lá»‡ (chá»¯ cÃ¡i A-Z, a-z hoáº·c sá»‘ 0-9).</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-31.png)

<p>Biáº¿n name Ä‘Æ°á»£c Ä‘Æ°a trá»±c tiáº¿p vÃ o template trÆ°á»›c khi render -> CÃ³ thá»ƒ exploit qua SSTI. Tuy nhiÃªn, Ä‘Ã£ giá»›i háº¡n cÃ¡c kÃ­ tá»± Ä‘áº·c biá»‡t nÃªn khÃ´ng thá»ƒ RCE Ä‘Æ°á»£c. NhÆ°ng váº«n cÃ³ thá»ƒ leak Ä‘Æ°á»£c thÃ´ng tin (PUBLICKEY, ...).</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-32.png)

<p>Endpoint /kings_lair, thá»±c hiá»‡n kiá»ƒm tra giÃ¡ trá»‹ cookie cá»§a user. DÃ²ng 131, giáº£i mÃ£ cookie vá»›i khÃ³a lÃ  PUBLICKEY vÃ  thuáº­t toÃ¡n lÃ  má»™t giÃ¡ trá»‹ báº¥t kÃ¬ trong máº£ng tráº£ vá». VÃ¬ thuáº­t toÃ¡n lÃ  giÃ¡ trá»‹ báº¥t kÃ¬ trong máº£ng (káº¿t quáº£ tráº£ vá» cá»§a get_default_algorithms()) nÃªn Æ°u tiÃªn chá»n thuáº­t toÃ¡n mÃ£ hÃ³a Ä‘á»‘i xá»©ng (1 PUBLICKEY lÃ  Ä‘á»§). Táº­n dá»¥ng SSTI Ä‘á»ƒ leak giÃ¡ trá»‹ cá»§a KINGSDAY Ä‘á»ƒ thá»a Ä‘iá»u kiá»‡n váº¿ thá»© nháº¥t cá»§a dÃ²ng 132. CÃ²n ROLE thÃ¬ thay Ä‘á»•i giÃ¡ trá»‹ thÃ nh royalty trÆ°á»›c khi encode lÃ  Ä‘Æ°á»£c. Náº¿u thá»a mÃ£n Ä‘iá»u kiá»‡n sáº½ tráº£ vá» kings_lair.html.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-33.png)

<p>Trong kings_lair.html, cÃ³ tráº£ vá» ná»™i dung flag -> Má»¥c tiÃªu Ä‘Ãºng lÃ  exploit qua cookie.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-39.png)

<p>Nháº­p giÃ¡ trá»‹ cá»§a name lÃ  <code>{{PUBLICKEY}}</code> vÃ  enter Ä‘á»ƒ leak ra giÃ¡ trá»‹.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-34.png)

<p>TÆ°Æ¡ng tá»±, nháº­p giÃ¡ trá»‹ cá»§a name lÃ  <code>{{KINGSDAY}}</code> vÃ  enter Ä‘á»ƒ leak ra giÃ¡ trá»‹.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-35.png)

<p>Táº¡o script báº±ng python dÃ¹ng Ä‘á»ƒ exploit cookie (lÆ°u Ã½: táº£i Ä‘Ãºng phiÃªn báº£n cá»§a jwt - PyJWT==2.3.0)</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-36.png)

<p>Cáº­p nháº­t giÃ¡ trá»‹ cookie vÃ  refresh -> Ná»™i dung flag Ä‘Ã£ Ä‘Æ°á»£c hiá»ƒn thá»‹ ra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-37.png)

# Playing_on_the_Backcourts
<p>Trong app_public.py, sink xuáº¥t hiá»‡n á»Ÿ dÃ²ng 115 cÃ³ thá»ƒ dáº«n Ä‘áº¿n RCE. Endpoint /get_eval láº¥y giÃ¡ trá»‹ cá»§a key 'expr' vÃ  Ä‘Æ°a vÃ o hÃ m deep_eval Ä‘á»ƒ láº¥y giÃ¡ trá»‹ tráº£ vá».</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-50.png)

<p>Thá»­ chuá»—i <code>1 + 2</code> vÃ  giÃ¡ trá»‹ result trong response tráº£ vá» lÃ  3 -> HÃ m eval Ä‘Ã£ thá»±c thi chuá»—i trÃªn vÃ  tráº£ vá» káº¿t quáº£.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-42.png)

<p>Tiáº¿p theo, chÃ¨n os command vá»›i lá»‡nh lÃ  <code>whoami</code>. Káº¿t quáº£ váº«n tráº£ vá» nhÆ° bÃ¬nh thÆ°á»ng.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-43.png)

<p>ChÆ°a rÃµ ná»™i dung flag náº±m á»Ÿ Ä‘Ã¢u -> Sá»­ dá»¥ng <code>ls</code> Ä‘á»ƒ liá»‡t kÃª cÃ¡c file trong mÃ£ nguá»“n.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-41.png)

<p>Khi xem láº¡i app_public.py thÃ¬ cÃ³ giÃ¡ trá»‹ cá»§a má»™t biáº¿n giÃ¡ giá»‘ng cáº¥u trÃºc flag -> CÃ³ váº» nhÆ° flag lÃ  giÃ¡ trá»‹ cá»§a biáº¿n safetytime.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-45.png)

<p>TÃ¬m tháº¥y chuá»—i cÃ³ cáº¥u trÃºc giá»‘ng flag trong app.py. Tuy nhiÃªn, khi thá»­ submit thÃ¬ Ä‘Ã¢y khÃ´ng pháº£i lÃ  flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-44.png)

<p>Thá»­ Ä‘á»c ná»™i dung leaderboard.txt.enc thÃ¬ khÃ´ng thÃ nh cÃ´ng. CÃ³ váº» nhÆ° dá»¯ liá»‡u trong file Ä‘Ã£ Ä‘Æ°á»£c mÃ£ hÃ³a.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-46.png)

<p>Kháº£ nÄƒng cao lÃ  trong Dockerfile sáº½ chá»©a cÃ¢u lá»‡nh Ä‘á»ƒ mÃ£ hÃ³a thÃ nh leaderboard.txt.enc -> TÃ¬m tháº¥y cÃ¢u lá»‡nh dÃ¹ng Ä‘á»ƒ mÃ£ hÃ³a vá»›i pass lÃ  giÃ¡ trá»‹ cá»§a biáº¿n mÃ´i trÆ°á»ng PASSPHRASE.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-47.png)

<p>In ra giÃ¡ trá»‹ cá»§a biáº¿n mÃ´i trÆ°á»ng PASSPHRASE -> Leak Ä‘Æ°á»£c giÃ¡ trá»‹ thÃ nh cÃ´ng. Tiáº¿p theo, cáº§n pháº£i giáº£i mÃ£ ná»™i dung file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-48.png)

<p>Sá»­ dá»¥ng base64 encode Ä‘á»ƒ láº¥y ná»™i dung ra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-49.png)

<p>Decode chuá»—i base64 vÃ  lÆ°u vÃ o file leaderboard.txt.enc trÃªn local. VÃ¬ trong base64 khÃ´ng cÃ³ kÃ­ tá»± \n nÃªn cáº§n thay tháº¿ báº±ng tá»• há»£p (shift + enter).</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-410.png)

<p>Báº¯t Ä‘áº§u giáº£i mÃ£ ná»™i dung leaderboard.txt.enc. CÃ³ warning xuáº¥t hiá»‡n nhÆ°ng khÃ´ng cáº§n quan tÃ¢m vÃ¬ viá»‡c giáº£i mÃ£ Ä‘Ã£ Ä‘Æ°á»£c thá»±c hiá»‡n xong.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-411.png)

<p>Äá»c ná»™i dung sau khi giáº£i mÃ£ -> TÃ¬m tháº¥y ná»™i dung flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post9/image-412.png)

<p>TÃ³m láº¡i, Ä‘Ã¢y lÃ  toÃ n bá»™ ná»™i dung vá» challenges. Hy vá»ng writeup nÃ y giÃºp Ã­ch cho báº¡n ğŸ”¥.</p>


