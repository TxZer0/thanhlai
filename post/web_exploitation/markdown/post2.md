# [Intigriti] Challenge-0125
<p>Báº¯t Ä‘áº§u thá»­ thÃ¡ch lÃ  má»™t trang yÃªu cáº§u nháº­p tÃªn cá»§a ngÆ°á»i dÃ¹ng. Sau khi submit thÃ¬ quay láº¡i /challenge vá»›i tham sá»‘ lÃ  text=name. Nháº¥n Close thÃ¬ trá»Ÿ vá» tráº¡ng thÃ¡i ban Ä‘áº§u.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image.png)

<p>Tiáº¿p theo, view page source Ä‘á»ƒ xem cÃ³ gÃ¬ Ä‘áº·c biá»‡t khÃ´ng. Sau khi submit thÃ¬ kÃ­ch hoáº¡t hÃ m redirectToText Ä‘á»ƒ xá»­ lÃ½ form.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-1.png)

<p>Chá»©c nÄƒng chÃ­nh cá»§a hÃ m nÃ y lÃ  encode name thÃ nh giÃ¡ trá»‹ há»£p lá»‡ trÃªn URL rá»“i chuyá»ƒn hÆ°á»›ng Ä‘áº¿n /challenge vá»›i tham sá»‘ text=name. ThÃ´ng thÆ°á»ng, window.location.href Ä‘Æ°á»£c gÃ¡n ="javascript:alert(origin)" Ä‘á»ƒ kÃ­ch hoáº¡t Ä‘Æ°á»£c XSS. Tuy nhiÃªn, trong trÆ°á»ng há»£p nÃ y window.location.href chuyá»ƒn hÆ°á»›ng má»™t url sá»­ dá»¥ng giao thá»©c https nÃªn khÃ´ng kÃ­ch hoáº¡t javascript á»Ÿ Ä‘Ã¢y Ä‘Æ°á»£c. HÆ°á»›ng Ä‘i tiáº¿p theo lÃ  tÃ¬m nÆ¡i nháº­n vÃ  xá»­ lÃ½ khi cÃ³ tham sá»‘ text.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-2.png)

<p>Tá»« dÃ²ng 229 Ä‘áº¿n 232, thá»±c hiá»‡n gá»i 2 hÃ m generateFallingParticles vÃ  checkQueryParam sau khi load láº¡i trang web.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-3.png)

<p>HÃ m generateFallingParticles thá»±c hiá»‡n Ä‘iá»u gÃ¬ Ä‘Ã³ nhÆ°ng khÃ´ng liÃªn quan Ä‘áº¿n viá»‡c xá»­ lÃ½ input nÃªn táº¡m thá»i bá» qua.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-4.png)

<p>HÃ m checkQueryParam chÃ­nh xÃ¡c lÃ  nÆ¡i xá»­ lÃ½ tham sá»‘ text cáº§n tÃ¬m. DÃ²ng 182, gá»i hÃ m getParameterByName vÃ  Ä‘á»‘i sá»‘ lÃ  text. DÃ²ng 183, kiá»ƒm tra náº¿u tham sá»‘ text tá»“n táº¡i vÃ  hÃ m XSS tráº£ vá» false thÃ¬ thá»±c hiá»‡n Ä‘oáº¡n mÃ£ bÃªn trong. DÃ²ng 186, cáº­p nháº­t ná»™i dung HTML báº±ng má»™t chuá»—i cÃ³ chá»©a giÃ¡ trá»‹ cá»§a tham sá»‘ text sau khi Ä‘i qua hÃ m getParameterByName -> XSS sink. Äiá»u cáº§n lÃ m bÃ¢y giá» lÃ  tÃ¬m hiá»ƒu 2 hÃ m getParameterByName vÃ  XSS hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-5.png)

<p>Báº¯t Ä‘áº§u vá»›i hÃ m getParameterByName trÆ°á»›c. VÃ¬ Ä‘á»‘i sá»‘ truyá»n vÃ o lÃ  text nÃªn biáº¿n name trong hÃ m nÃ y Ä‘ang cÃ³ giÃ¡ trá»‹ lÃ  text. DÃ²ng 164, gá»i hÃ m replace Ä‘á»ƒ thÃªm \ vÃ o trÆ°á»›c kÃ­ tá»± [ hoáº·c ] trong chuá»—i. VÃ¬ chuá»—i Ä‘ang lÃ  text nÃªn khÃ´ng cÃ³ chuá»—i nÃ o khá»›p nÃªn giÃ¡ trá»‹ váº«n lÃ  text. DÃ²ng 165, táº¡o má»™t regex gÃ¬ Ä‘Ã³ cÃ³ váº» nhÆ° Ä‘á»ƒ match vá»›i cÃ¡c tham sá»‘ trÃªn URL vÃ  dÃ²ng 166 thá»±c hiá»‡n tÃ¬m kiáº¿m trong URL. Cuá»‘i cÃ¹ng, tráº£ vá» giÃ¡ trá»‹ cá»§a tham sá»‘ sau khi decode.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-6.png)

<p>Chá»©c nÄƒng chÃ­nh cá»§a hÃ m XSS nÃ y lÃ  tráº£ true náº¿u tá»“n táº¡i kÃ­ tá»± < hoáº·c lÃ  > trÃªn pháº§n query string hoáº·c pháº§n hash -> NÃ³i chung, Ä‘á»ƒ hÃ m XSS tráº£ vá» false thÃ¬ sau kÃ­ tá»± ? trong URL khÃ´ng Ä‘Æ°á»£c phÃ©p chá»©a kÃ­ tá»± < hoáº·c lÃ  >.</p>

```
function XSS() {
    return  decodeURIComponent(window.location.search).includes('<')    || 
            decodeURIComponent(window.location.search).includes('>')    || 
            decodeURIComponent(window.location.hash).includes('<')      || 
            decodeURIComponent(window.location.hash).includes('>')
}
```
<p>NÃ³i chung thÃ¬ hÃ m getParameterByName láº¥y toÃ n bá»™ URL ra vÃ  sá»­ dá»¥ng regex Ä‘á»ƒ tÃ¬m ra tham sá»‘ text. Sau Ä‘Ã³, hÃ m XSS láº¥y pháº§n tá»« sau ? Ä‘á»ƒ kiá»ƒm tra náº¿u tá»“n táº¡i < hoáº·c > thÃ¬ false vÃ  khÃ´ng Ä‘i tá»›i Ä‘Æ°á»£c sink. Váº­y cÃ¢u há»i Ä‘áº·t ra lÃ : "LÃ m tháº¿ nÃ o Ä‘á»ƒ vá»«a thá»a regex mÃ  khÃ´ng náº±m sau kÃ­ tá»± ? trong URL?".</p>

<p>BÃ¢y giá», cáº§n phÃ¢n tÃ­ch cáº¥u trÃºc cá»§a URL (vÃ­ dá»¥: http://example.com/path?query#fragment). Äáº§u tiÃªn, cáº§n loáº¡i ?query#fragment vÃ¬ hÃ m XSS sáº½ kiá»ƒm tra pháº§n nÃ y. Äoáº¡n https://example.com/ cÅ©ng khÃ´ng thá»ƒ thay Ä‘á»•i vÃ¬ thay Ä‘á»•i Ä‘á»‹a chá»‰ thÃ¬ cÃ²n lÃ m Ä‘Æ°á»£c gÃ¬ ná»¯a Ä‘Ã¢u -> NÆ¡i duy nháº¥t kháº£ thi lÃ  pháº§n path. Regex Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ tÃ¬m tham sá»‘ text trong URL, báº¥t ká»ƒ nÃ³ á»Ÿ dáº¡ng ?text=value1 hoáº·c &text=value2 Ä‘á»u thá»a mÃ£n. Cuá»‘i cÃ¹ng thÃ¬ path pháº£i cÃ³ dáº¡ng: &text=value2 sáº½ bypass Ä‘Æ°á»£c hÃ m XSS.</p>

<p>Tuy nhiÃªn, khi thÃªm &amp;text=&lt;h1&gt;a vÃ o pháº§n path thÃ¬ sáº½ phÃ¡t sinh thÃªm má»™t váº¥n Ä‘á» lÃ  truy cáº­p vÃ o má»™t trang khÃ´ng tá»“n táº¡i. Váº­y thÃ¬ cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ thÃªm &amp;text=&lt;h1&gt;a mÃ  Ä‘Æ°á»ng dáº«n váº«n di chuyá»ƒn tá»›i /challenge hay khÃ´ng ? Theo mÃ¬nh nhá»› thÃ¬ cÃ³ má»™t lá»—i khi cáº¥u hÃ¬nh Nginx dáº«n Ä‘áº¿n path traversal.</p>

<p>Thá»­ truy cáº­p vÃ o má»™t Ä‘Æ°á»ng dáº«n khÃ´ng tá»“n táº¡i thÃ¬ xÃ¡c Ä‘á»‹nh trang nÃ y sá»­ dá»¥ng nginx lÃ m web server.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-8.png)

<p>Äá»ƒ trÃ¡nh bá»‹ tá»± Ä‘á»™ng chuáº©n hÃ³a Ä‘Æ°á»ng dáº«n, mÃ¬nh sáº½ encode URL kÃ­ tá»± / thÃ nh %2f Sau khi thá»­ cÃ¡c trÆ°á»ng há»£p ..%2f vÃ  %2f.. thÃ¬ phÃ¡t hiá»‡n ra URL: `https://challenge-0125.intigriti.io/challenge/abc%2f..%2f..%2fchallenge` nÃ y tráº£ vá» chÃ­nh xÃ¡c trang /challenge. </p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-7.png)

<p>Tiáº¿p theo, sá»­ dá»¥ng &lt;img src=x onerror=alert(origin)&gt;
 Ä‘á»ƒ trigger XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-9.png)

<p>Tuy nhiÃªn, path: `/challenge/&text=&lt;img src=x onerror=alert(origin)&gt;%2f..%2f..%2fchallenge` váº«n cÃ³ thá»ƒ rÃºt ngáº¯n hÆ¡n ná»¯a báº±ng `/challenge/&text=&lt;img src=x onerror=alert(origin)&gt;%2f..`</p>

![alt text](/thanhlai/post/web_exploitation/image/post2/image-10.png)

<p>TÃ³m láº¡i, Ä‘Ã¢y lÃ  toÃ n bá»™ ná»™i dung vá» challenge. Hy vá»ng writeups nÃ y giÃºp Ã­ch cho báº¡n ğŸ”¥.</p>

