# XSS via dangerous Content-Type header
<p>Source code: <a href="/thanhlai/post/web_exploitation/script/index.txt">index.php</a></p>
<p>Đầu tiên, trang web yêu cầu upload file XML. Sau khi upload thì hiển thị 2 nút đại diện cho 2 chế độ: Preview (xem trước) và Download (tải về).</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image.png)

<p>Chọn Preview thì nội dung XML được hiển thị trực tiếp. Còn Download thì tải file XML về.</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image-1.png)

<p>Dòng 29-45, thực hiện xử lý file được upload lên server. Dòng 37, hàm uniqid tạo ra tên file duy nhất nối với chuỗi ".xml" thành tên file để lưu vào thư mục /uploads.</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image-2.png)

<p>Dòng 10-14, xác định action mà user gửi tới để set giá trị cho header Content-Disposition trong response. Giữa 2 giá trị inline và attachment thì chắc chắn XSS có khả năng xảy ra ở inline vì browser sẽ render nội dung file XML. Vậy làm sao để nội dung XML có thể trigger XSS ?</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image-3.png)

<p>Có một vector có trigger XSS thông qua XML . Đó là nhúng nội dung XHTML (ngôn ngữ đánh dấu giống HTML nhưng tuân thủ chặt chẽ cú pháp của XML) vào XML bằng namespace.</p>

<p>Ví dụ: đây là một nội dung XML: <code>&lt;x:b xmlns:x="http://www.w3.org/1999/xhtml">HELLO&lt;/x:b></code>  sử dụng namespace <b>x</b> để xác định nội dung XHTML. Tag &lt;x:b> tương đương với thẻ &lt;b> trong HTML – dùng để in đậm chữ.</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image-4.png)

<p>Được kế thừa từ HTML nên XHTML cũng có tag &lt;script>, &lt;a>, &lt;img>,... (các tag hoặc thuộc tính trong tag có thể run Javascript). Từ đó, có thể trigger XSS thông qua nội dung XHTML. Tóm lại, từ việc load XML (Content-Type: text/xml) -> thuộc tính xmlns trỏ tới namespace của XHTML -> XHTML trigger XSS thông qua tag &lt;script>.</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image-5.png)

<p>Cuối cùng, thay đổi payload thành: <code>&lt;x:script xmlns:x="http://www.w3.org/1999/xhtml">alert(document.cookie)&lt;/x:script></code> để hiển thị cookie. Các bước thực hiện: upload file XML chứa payload XSS -> Chọn Preview</p>

![alt text](/thanhlai/post/web_exploitation/image/post15/image-7.png)