# [LACTF-2023] 85-reasons-why
<p>Trong /app/views.py, dòng 61 thực hiện truy vấn sql thủ công. Điều đáng chú ý là biến spic được nhúng trực tiếp vào câu query mà spic là giá trị sau khi serialize nội dung của file mà người dùng upload lên -> Người dùng có thể tác động trực tiếp lên câu truy vấn và dẫn đến SQL injection. Trước hết cần phải kiểm tra hàm serialize_image hoạt động như thế nào ?</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image.png)

<p>Dòng 11, thực hiện encode dữ liệu nhị phân của file upload lên thành base85. Dòng 12, chuyển base85 từ bytes sang string. Sau đó, có 4 giai đoạn thực hiện replace và trả về giá trị cuối cùng. Regex đầu tiên chưa rõ là replace chính xác chuỗi cụ thể nào (tí sẽ kiểm tra) thành kí tự ~. Regex thứ hai replace kí tự ' thành 2 kí tự '. Regex thứ ba đưa kí tự ~ trở thành dấu '. Cuối cùng thay thế : thành ~. Có vẻ regex thứ nhất và ba là điểm mấu chốt để thực hiện SQL injection vì chuỗi khớp với pattern thứ nhất được chuyển thành ~ nhưng sau đó lại chuyển ~ thành ' -> Có thể lợi dụng việc này để khiến việc replace tự động đưa kí tự ' vào payload.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-1.png)

<p>Thử dùng lệnh print để in ra regex thứ nhất thì biết được chuỗi sẽ bị replace thành ~ là 6 kí tự \ và 1 kí tự '. Tuy nhiên, để in ra \\\\\\' thì vẫn phải sử dụng \\\\\\\\\\\\\'.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-2.png)

<p>Chuỗi base85 hiện tại dùng để exploit sẽ như sau: \\\\\\\\\\\\\' OR 1=1-- . Tuy nhiên, trong base85 không chứa các kí tự khoảng trắng như: space, tab, newline nên cần phải sử dụng cú pháp /**/ trong SQL để thay thế cho kí tự khoảng trắng. Chuỗi base85 hoàn chỉnh dùng để kích hoạt SQL injection: \\\\\\\\\\\\\'/**/OR/**/1=1--/**/. Vì các byte được đưa vào hàm serialize_image để encode base85 rồi đem chuỗi base65 đó nhúng vào câu query nên cần phải decode base85 trước rồi mới ghi vào file. Ở đây, đuôi file không nhất thiết phải là png vì hàm image_search không kiểm tra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-3.png)

<p>Gửi output.bin lên chức năng search-image -> Câu query đã thực hiện list ra toàn bộ bài post và leak ra flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-4.png)

<p>Tóm lại, đây là toàn bộ nội dung về challenge. Hy vọng writeup này giúp ích cho bạn 🔥.</p>
