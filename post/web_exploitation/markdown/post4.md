# [LACTF-2023] 85-reasons-why
<p>Trong /app/views.py, dÃ²ng 61 thá»±c hiá»‡n truy váº¥n sql thá»§ cÃ´ng. Äiá»u Ä‘Ã¡ng chÃº Ã½ lÃ  biáº¿n spic Ä‘Æ°á»£c nhÃºng trá»±c tiáº¿p vÃ o cÃ¢u query mÃ  spic lÃ  giÃ¡ trá»‹ sau khi serialize ná»™i dung cá»§a file mÃ  ngÆ°á»i dÃ¹ng upload lÃªn -> NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ tÃ¡c Ä‘á»™ng trá»±c tiáº¿p lÃªn cÃ¢u truy váº¥n vÃ  dáº«n Ä‘áº¿n SQL injection. TrÆ°á»›c háº¿t cáº§n pháº£i kiá»ƒm tra hÃ m serialize_image hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o ?</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image.png)

<p>DÃ²ng 11, thá»±c hiá»‡n encode dá»¯ liá»‡u nhá»‹ phÃ¢n cá»§a file upload lÃªn thÃ nh base85. DÃ²ng 12, chuyá»ƒn base85 tá»« bytes sang string. Sau Ä‘Ã³, cÃ³ 4 giai Ä‘oáº¡n thá»±c hiá»‡n replace vÃ  tráº£ vá» giÃ¡ trá»‹ cuá»‘i cÃ¹ng. Regex Ä‘áº§u tiÃªn chÆ°a rÃµ lÃ  replace chÃ­nh xÃ¡c chuá»—i cá»¥ thá»ƒ nÃ o (tÃ­ sáº½ kiá»ƒm tra) thÃ nh kÃ­ tá»± ~. Regex thá»© hai replace kÃ­ tá»± ' thÃ nh 2 kÃ­ tá»± '. Regex thá»© ba Ä‘Æ°a kÃ­ tá»± ~ trá»Ÿ thÃ nh dáº¥u '. Cuá»‘i cÃ¹ng thay tháº¿ : thÃ nh ~. CÃ³ váº» regex thá»© nháº¥t vÃ  ba lÃ  Ä‘iá»ƒm máº¥u chá»‘t Ä‘á»ƒ thá»±c hiá»‡n SQL injection vÃ¬ chuá»—i khá»›p vá»›i pattern thá»© nháº¥t Ä‘Æ°á»£c chuyá»ƒn thÃ nh ~ nhÆ°ng sau Ä‘Ã³ láº¡i chuyá»ƒn ~ thÃ nh ' -> CÃ³ thá»ƒ lá»£i dá»¥ng viá»‡c nÃ y Ä‘á»ƒ khiáº¿n viá»‡c replace tá»± Ä‘á»™ng Ä‘Æ°a kÃ­ tá»± ' vÃ o payload.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-1.png)

<p>Thá»­ dÃ¹ng lá»‡nh print Ä‘á»ƒ in ra regex thá»© nháº¥t thÃ¬ biáº¿t Ä‘Æ°á»£c chuá»—i sáº½ bá»‹ replace thÃ nh ~ lÃ  6 kÃ­ tá»± \ vÃ  1 kÃ­ tá»± '. Tuy nhiÃªn, Ä‘á»ƒ in ra \\\\\\' thÃ¬ váº«n pháº£i sá»­ dá»¥ng \\\\\\\\\\\\\'.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-2.png)

<p>Chuá»—i base85 hiá»‡n táº¡i dÃ¹ng Ä‘á»ƒ exploit sáº½ nhÆ° sau: \\\\\\\\\\\\\' OR 1=1-- . Tuy nhiÃªn, trong base85 khÃ´ng chá»©a cÃ¡c kÃ­ tá»± khoáº£ng tráº¯ng nhÆ°: space, tab, newline nÃªn cáº§n pháº£i sá»­ dá»¥ng cÃº phÃ¡p /**/ trong SQL Ä‘á»ƒ thay tháº¿ cho kÃ­ tá»± khoáº£ng tráº¯ng. Chuá»—i base85 hoÃ n chá»‰nh dÃ¹ng Ä‘á»ƒ kÃ­ch hoáº¡t SQL injection: \\\\\\\\\\\\\'/**/OR/**/1=1--/**/. VÃ¬ cÃ¡c byte Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ m serialize_image Ä‘á»ƒ encode base85 rá»“i Ä‘em chuá»—i base65 Ä‘Ã³ nhÃºng vÃ o cÃ¢u query nÃªn cáº§n pháº£i decode base85 trÆ°á»›c rá»“i má»›i ghi vÃ o file. á» Ä‘Ã¢y, Ä‘uÃ´i file khÃ´ng nháº¥t thiáº¿t pháº£i lÃ  png vÃ¬ hÃ m image_search khÃ´ng kiá»ƒm tra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-3.png)

<p>Gá»­i output.bin lÃªn chá»©c nÄƒng search-image -> CÃ¢u query Ä‘Ã£ thá»±c hiá»‡n list ra toÃ n bá»™ bÃ i post vÃ  leak ra flag.</p>

![alt text](/thanhlai/post/web_exploitation/image/post4/image-4.png)

<p>TÃ³m láº¡i, Ä‘Ã¢y lÃ  toÃ n bá»™ ná»™i dung vá» challenge. Hy vá»ng writeup nÃ y giÃºp Ã­ch cho báº¡n ğŸ”¥.</p>
