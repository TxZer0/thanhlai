# [HackTheBox] Spookifier
<p>Đầu tiên, khi nhập name và click vào nút SpookiSpookify thì trả về 4 font khác nhau của input. Quan sát URL, thấy được rằng input được gửi qua tham số text.</p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image.png)

<p>Tham số text được đưa vào hàm spookify trong file utils.py để xử lý và trả về cùng với template </p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image-1.png)

<p>Dòng 307 trong utils.py thực hiện đưa tham số text vào hàm change_font -> Có vẻ như hàm này trả về 4 font khác nhau của input. Cuối cùng, trả về kết quả sau khi đưa 4 font đó vào hàm generate_render.</p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image-2.png)

<p>Điều đặc biệt trong 4 font này là font thứ 4 hoàn toàn không thay đổi ký tự gốc mà giữ nguyên chữ cái, số và ký tự đặc biệt.</p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image-6.png)

<p>Hàm generate_render tạo ra một template HTML với 4 font khác nhau và trả về kết quả sau khi render HTML -> Đoạn code này gây ra lỗi SSTI vì input có thể tác dụng trực tiếp vào template engine trước khi render. Vì font thứ 4 vẫn giữ nguyên giá trị của input nên có thể thực thi code trong template.</p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image-3.png)

<p>Vì trang web này sử dụng template engine là Mako (dựa vào import, Dockerfile có sẵn) nên payload sẽ có dạng ${}. Thử ${2 - 1} thì kết quả trả về ở hàng thứ 4 chính xác là 1.</p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image-4.png)

<p>Payload hoàn chỉnh để đọc nội dung flag: ${__import__('os').popen('cat /flag.txt').read()}. Dùng __import__('os') để import os, rồi gọi os.popen('cat /flag.txt').read() để thực thi lệnh, lấy nội dung /flag.txt và hiển thị ra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post5/image-5.png)

<p>Tóm lại, đây là toàn bộ nội dung về challenge. Hy vọng writeups này giúp ích cho bạn 🔥.</p>