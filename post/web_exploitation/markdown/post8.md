# [XSS PwnFunction] Warmups
## Ma Spaghet!
<p>Đầu tiên, lấy giá trị của tham số somebody từ URL (nếu có). Sau đó, cập nhật nội dung vào phần tử có id="spaghet" bằng innerHTML.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image.png)

<p>Dùng payload: <code>&lt;img src=x onerror=alert(1337)&gt;</code> để trigger XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-1.png)

## Jefff
<p>Ở challenge này, innerText được dùng để cập nhât nội dung -> Dòng 33 không gây ra XSS. Tuy nhiên, giá trị của tham số jeff từ URL được đưa vào một đoạn mã JavaScript dạng chuỗi, sau đó hàm eval thực thi đoạn mã đó -> Có thể trigger bằng cách nối dài đoạn mã đó ra.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-2.png)

<p>Đầu tiên, thêm " để đóng chuỗi. Thêm ; để đóng lệnh JavaScript hiện tại. Chèn câu lệnh alert(1337); để trigger. Cuối cùng, comment kí tự " bằng cách sử dụng // -> Payload: <code>";alert(1337);//</code></p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-3.png)

## Ugandan Knuckles
<p>Vị trí để trigger XSS ở challenge này nằm trong chuỗi được dùng để cập nhập nội dung của phần tử có id="uganda". Dòng 32, thực hiện replace kí tự < và > thành rỗng -> Có vẻ cần khai thác thông qua event handler.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-4.png)

<p>Đầu tiên, thêm " để đóng chuỗi giá trị của thuộc tính placeholder. Sử dụng các sự kiện của tag input như: onclick, oninput, oncopy,... để trigger XSS -> Payload: <code>" oninput="alert(1337)</code>. Vì oninput kích hoạt khi giá trị của tag input thay đổi nên nhập giá trị vào ô để trigger payload. Tuy nhiên, vẫn đang cần tương tác để trigger nên phải tìm thuộc tính nào có thể tự động trigger mà không cần tương tác.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-5.png)

<p>Sử dụng thuộc tính autofocus kết hợp với sự kiện onfocus để tự động trigger mà không cần tương tác.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-23.png)

## Ricardo Milos
<p>Dòng 32, lấy ra giá trị tham số ricardo trên URL (nếu có) và đặt làm giá trị của thuộc tính action trong form có id="ricardo". Sau 2 giây, form tự động submit đến URL đã lấy từ tham số ricardo -> Có vẻ challenge này hướng tới việc trigger XSS qua URL bằng giao thức javascript.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-6.png)

<p>Payload: <code>javascript:alert(1337)</code></p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-7.png)

## Ah That's Hawt

<p>Dòng 30, thực hiện replace các kí tự ( ) ` \ trong chuỗi giá trị của tham số markassbrownlee thành rỗng. Các kí tự hữu ích còn sử dụng là " ' < >. Có vẻ cần phải encode sang dạng khác thì mới có thể thực thi alert(1337) được.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-8.png)

<p>Có một cách có thể trigger XSS thông qua giao thức data (ví dụ: <code>&lt;a href="data:text/html,alert()">Click me&lt;/a></code>
). Tuy nhiên, để no user interactive thì cần phải sử dụng tag khác có nhận giao thức data như: object, embed,... Kết hợp với việc data có thể nhận dữ liệu dưới dạng base64 thì có được cấu trúc payload như sau: <code>&lt;object data="data:text/html;base64,[chuỗi &lt;img src=x onerror=alert(1337)> đã bị encode base64]"></code>.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-9.png)

## Ligma
<p>Ở challenge này, các kí tự: từ a đến z, A đến Z và số đều bị replace thành rỗng. Vậy có cách nào để thực thi JavaScript code mà không dùng chữ cái (a-z, A-Z) và số (0-9) không ?</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-11.png)

<p>Trong JavaScript, có một kỹ thuật chỉ sử dụng sáu ký tự đặc biệt [ ] ( ) ! + để lập trình gọi là JSFuck. Encode chuỗi alert(1337) sang JSFuck và đưa vào hàm eval -> Hàm eval thực thi alert(1) và hiển thị ra alert box.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-12.png)

<p>Trước tiên, cần phải encodeURL chuỗi JSFuck để bảo toàn chuỗi JSFuck ban đầu khi lấy ra giá trị của tham số.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-13.png)

<p>Đưa chuỗi JSFuck sau khi encodeURL vào tham số balls -> Trigger XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-14.png)

## Mafia
<p>Các kí tự ` ' " + - ! \ [ ] và chuỗi alert trong giá trị của tham số mafia bị replace thành _. Cuối cùng, đưa vào hàm eval để thực thi -> Mục tiêu: phải đưa chuỗi alert(1337) vào hàm eval để trigger XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-15.png)

<p>Ý tưởng bây giờ là cố gắng đưa chuỗi alert(1) trên URL vào hàm eval bằng cách thêm một tham số (kiểu: param1=value1&amp;param2=alert(1337)). Để lấy được giá trị của toàn bộ tham số thì sử dụng <code>location.search</code>. Tiếp theo, sử dụng slice để lấy chuỗi alert(1337) của tham số thứ hai. Tuy nhiên, cần thêm để một hàm eval nữa để thực thi <code>location.search.slice()</code> và trả về alert(1337) trước khi eval bên ngoài thực thi.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-16.png)

<p>Payload: <code>eval(location.search.slice(44))&test=alert(1337)</code></p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-17.png)

## Ok, Boomer
<p>Ở challenge này, tham số được đưa vào hàm sanitize của thư viện DOMPurify. Có vẻ như dùng để ngăn chặn XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-18.png)

<p>Thử <code>&lt;img src=x onerror=alert()></code> -> Event handler onerror đã bị remove.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-19.png)

<p>Thử <code>&lt;script src=x onerror=alert()>&lt;/script></code> -> Toàn bộ phần tử script đã bị remove.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-20.png)

<p>Với tag a thì chỉ bị remove khi giao thức là javascript. Có vẻ như giao thức được xem là an toàn thì sẽ không bị remove. Nếu không hợp lệ cũng bị remove luôn.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-21.png)

<p>Nhìn chung, hàm sanitize sẽ loại bỏ khi có các tag, event handler, url scheme được xem là nguy hiểm -> Vậy những thứ nào được xem là không nguy hiểm nhưng lại có thể trigger XSS?</p>

<p>Quan sát file ok-boomer.html, biến ok không được khai báo nên gây ra lỗi ở dòng 32 -> Có thể bị khai thác bằng DOM clobbering.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-22.png)

<p>Khi được tạo ra bởi phần tử có id trùng tên, biến ok có kiểu là object. Bởi vì type là object nên khi vào hàm setTimeout thì JavaScript sẽ tự động gọi hàm toString để trả về lệnh JavaScript cho setTimeout thực hiện. Có 2 tag khá đặc biệt có thể vừa trigger XSS qua URL vừa có thể trỏ đến giá trị của thuộc tính trigger XSS (href) khi gọi hàm toString. Đó là tag a và area. Khi gọi hàm toString của object có id="ok" thì kết quả trả về là giá trị của thuộc tính href. Payload hiện tại: <code>&lt;a id="ok" href="[scheme]:alert(1337)"></code> (scheme phải là giá trị hợp lệ để không bị remove bởi hàm sanitize).</p>

<p>Tiếp theo, kiểm tra setTimeout nhận chuỗi như thế nào để thực thi -> Có vẻ như trước kí tự : thì tồn tại chuỗi gì cũng được -> Việc còn lại là xem hàm sanitize xem những scheme nào là hợp lệ.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-24.png)

<p>Thử payload: <code>&lt;a id="ok" href="http:alert(1)"</code> do biết rằng lúc nãy http được chấp nhận là scheme hợp lệ. Tuy nhiên, đã bị lỗi ở đoạn nào đó.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-25.png)

<p>Sau khi in ra giá trị của thuộc tính href và đưa vào hàm setTimeout thì biết được rằng khi scheme là http nó sẽ parse thành "http://localhost:5500/alert(origin)" và làm cho hàm setTimeout bị lỗi.</p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-26.png)

<p>Thử một loạt các scheme khác thì tìm ra scheme là <b>mailto</b> vừa được chấp nhận khi qua hàm sanitize và vừa hợp lệ khi vào hàm setTimeout -> Payload cuối cùng: <code>&lt;a id="ok" href="mailto:alert(1337)"</code></p>

![alt text](/thanhlai/post/web_exploitation/image/post8/image-10.png)
