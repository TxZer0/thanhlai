# [Intigriti] Challenge-0524
<p>Đầu tiên, trang web này có chức năng tìm x của phương trình bậc 2 với các hệ số A, B, C do người dùng nhập vào.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image.png)

<p>View source: nơi cần chú ý là 2 dòng code sử dụng echo để in giá trị nghiệm nằm trong phần else có khả năng bị XSS nếu như kết quả trả về của hàm calculateFormula không được xử lý đúng cách. Đối số truyền vào là biểu thức tính toán chứa các giá trị hệ số nhận từ user input.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-1.png)

<p>Bắt đầu tìm hiểu sơ lược về hàm calculateFormula trong lớp Calculation. Bằng cách search đường dẫn "PhpOffice\PhpSpreadsheet\Calculation\Calculation" được khai báo trong PHP thì mình đã tìm ra file Calculation.php ở trên github. Tuy nhiên, chưa rõ version chính xác của Calculation.php mà web này sử dụng. Thử sử dụng chức năng blame của github thì mình phát hiện ra rằng hầu như tất cả các dòng code trong file này đều được update gần đây nhất là 2 năm trước. Mà hiện tại là đầu năm 2025 nên không cần phải quan tâm về version nữa.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-2.png)

<p>Biểu thức chỉ được dùng duy nhất tại dòng 365 để trả về kết quả sau khi tính toán. Dòng 3636-3637, thực hiện catch tất cả các ngoại lệ và ném ra thông báo lỗi -> Có khả năng input sẽ xuất hiện thông báo lỗi và có thể dẫn đến XSS nếu được render trực tiếp trên browser.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-3.png)

<p>Thử sử dụng chuỗi bất kì để gây ra lỗi thì giá trị của hệ số B được hiển thị bên trong thông báo lỗi.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-5.png)

<p>Tuy nhiên, các kí tự < hoặc > đã bị escape -> Không có XSS khi render thông báo lỗi -> Hướng đi này là fail.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-4.png)

<p>Tiếp tục, đi vào hàm _calculateFormulaValue thì thấy biểu thức được xử lý qua khá nhiều bước nên phân tích từng dòng code khá mất thời gian và có thể không hiệu quả (tạm thời để đó). Tuy nhiên, không tìm thấy nơi có dấu hiệu xử lý để ngăn chặn XSS.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-6.png)

<p>Vì Calculation.php nằm trong một dự án khá là lâu đời rồi nên chắc sẽ có tài liệu để tham khảo. Khi đọc sơ qua: "https://phpspreadsheet.readthedocs.io/en/latest/topics/calculation-engine/" thì thấy rằng các biểu thức tính toán trong đây được tính toán và xử lý khá giống Excel. Vì mục tiêu là chèn payload xss vào mà biểu thức vẫn hợp lệ nên câu hỏi đặt ra bây giờ là "Có chức năng có thể nối chuỗi (payload XSS) vào kết quả sau khi tính toán không?" (Ví dụ: "Kết quả của 1 + 2 là: 3", trong đó 3 là giá trị sau khi tính biểu thức 1 + 2). Sau khi nhờ đến sự trợ giúp của google thì mình tìm ra một cách khá đơn giản chỉ cần sử dụng kí tự & để nối các chuỗi lại với nhau.</p>

<p>Mục tiêu bây giờ là nối dài biểu thức đó ra và nối giá trị của biểu thức với chuỗi "&lt;h1&gt;abc"</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-7.png)

<p>Thêm 1 kí tự ) vẫn hoạt động bình thường.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-8.png)

<p>Thử nối với chuỗi "&lt;h1&gt;abc" thì bị lỗi. Tuy nhiên, lúc nãy dư một kí tự ) vẫn hoạt động bình thường nên mình sẽ thử thêm kí tự ).</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-9.png)

<p>Lúc này, có vẻ như là sai định dạng nhưng chuỗi "&lt;h1&gt;abc" vẫn được in ra. Chèn được html thành công.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-10.png)

<p>Thay đổi payload thành `1)&amp;&quot;&lt;script&gt;alert(origin)&lt;/script&gt;&quot;)` -> Trigger XSS thành công.</p>

![alt text](/thanhlai/post/web_exploitation/image/post3/image-11.png)

<p>Tóm lại, đây là toàn bộ nội dung về challenge. Hy vọng writeup này giúp ích cho bạn 🔥.</p>
